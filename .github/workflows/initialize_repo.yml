name: Initialize repo after generated from template

on: push

jobs:
  initialize:
    if: github.repository != 'picktrace/terraform-template' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    steps:
    - name: Checkout the main branch
      uses: actions/checkout@v2
      with:
        ref: main
    - name: Update templates
      run: |
        author=${{ github.actor }}
        full_repo_name=${{ github.repository }}
        org=${{ github.repository_owner }}
        repo_name=${full_repo_name#$org/}
        svc_name=${repo_name%-tf}
        sed -i "s/<REPO_NAME>/$repo_name/g" terraform/terraform.tf
        sed -i "s/<SERVICE_NAME>/$svc_name/g" terraform/vars.tf
        sed -i "s/<OWNER>/$author/g" terraform/vars.tf
        mv README.md.tmpl README.md
        sed -i "s/<SERVICE_NAME>/$svc_name/g" README.md
    - name: Remove repo initialization workflow
      run: rm .github/workflows/initialize_repo.yml
    - name: Commit changes
      uses: actions-x/commit@v6
      with:
        branch: main
        message: New Terraform repo initialization
        name: Terraform Bot
        email: terraform@picktrace.com
